<div class="modal-backdrop" [class.visible]="isOpen" (click)="closeModal()">
	<div class="modal-container" (click)="$event.stopPropagation()">
		<header class="modal-header">
			<h2>
				<mat-icon>lock</mat-icon>
				Cambiar Contraseña
			</h2>
			<button mat-icon-button class="close-button" (click)="closeModal()" [disabled]="isChangingPassword()">
				<mat-icon>close</mat-icon>
			</button>
		</header>

		<div class="modal-content">
			<form [formGroup]="passwordForm" class="modal-form" (ngSubmit)="changePassword()">
				<!-- Contraseña Actual -->
				<div class="custom-input-group">
					<input id="modalCurrentPassword" [type]="showCurrentPassword() ? 'text' : 'password'"
						formControlName="currentPassword" placeholder=" "
						[class.error]="currentPasswordErrors.length > 0">
					<label for="modalCurrentPassword">Contraseña Actual</label>
					<button type="button" class="password-toggle" (click)="togglePasswordVisibility('current')">
						<mat-icon>{{ showCurrentPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
					</button>
					@if (currentPasswordErrors.length > 0) {
					<div class="error-messages">
						@for (error of currentPasswordErrors; track error) {
						<div class="error-message">{{ error }}</div>
						}
					</div>
					}
				</div>

				<!-- Nueva Contraseña -->
				<div class="custom-input-group">
					<input id="modalNewPassword" [type]="showNewPassword() ? 'text' : 'password'"
						formControlName="newPassword" placeholder=" " [class.error]="newPasswordErrors.length > 0">
					<label for="modalNewPassword">Nueva Contraseña</label>
					<button type="button" class="password-toggle" (click)="togglePasswordVisibility('new')">
						<mat-icon>{{ showNewPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
					</button>
					@if (newPasswordErrors.length > 0) {
					<div class="error-messages">
						@for (error of newPasswordErrors; track error) {
						<div class="error-message">{{ error }}</div>
						}
					</div>
					}
				</div>

				<!-- Confirmar Contraseña -->
				<div class="custom-input-group">
					<input id="modalConfirmPassword" [type]="showConfirmPassword() ? 'text' : 'password'"
						formControlName="confirmPassword" placeholder=" "
						[class.error]="confirmPasswordErrors.length > 0">
					<label for="modalConfirmPassword">Confirmar Contraseña</label>
					<button type="button" class="password-toggle" (click)="togglePasswordVisibility('confirm')">
						<mat-icon>{{ showConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
					</button>
					@if (confirmPasswordErrors.length > 0) {
					<div class="error-messages">
						@for (error of confirmPasswordErrors; track error) {
						<div class="error-message">{{ error }}</div>
						}
					</div>
					}
				</div>

				<!-- Enlace de recuperación de contraseña -->
				<div class="recover-password-link">
					<a (click)="onForgotPassword()" >
						<mat-icon>help_outline</mat-icon>
						¿Olvidaste tu contraseña?
					</a>
				</div>

				<!-- Requisitos de Contraseña -->
				<div class="password-requirements">
					<h4>La contraseña debe contener:</h4>
					<ul class="requirements-list">
						<li [class.valid]="hasMinLength()" [class.invalid]="!hasMinLength() && newPassword()">
							<mat-icon class="requirement-icon">{{ hasMinLength() ? 'check_circle' :
								'radio_button_unchecked' }}</mat-icon>
							Mínimo 8 caracteres
						</li>
						<li [class.valid]="hasUpperCase()" [class.invalid]="!hasUpperCase() && newPassword()">
							<mat-icon class="requirement-icon">{{ hasUpperCase() ? 'check_circle' :
								'radio_button_unchecked' }}</mat-icon>
							Al menos una mayúscula (A-Z)
						</li>
						<li [class.valid]="hasLowerCase()" [class.invalid]="!hasLowerCase() && newPassword()">
							<mat-icon class="requirement-icon">{{ hasLowerCase() ? 'check_circle' :
								'radio_button_unchecked' }}</mat-icon>
							Al menos una minúscula (a-z)
						</li>
						<li [class.valid]="hasNumber()" [class.invalid]="!hasNumber() && newPassword()">
							<mat-icon class="requirement-icon">{{ hasNumber() ? 'check_circle' :
								'radio_button_unchecked' }}</mat-icon>
							Al menos un número (0-9)
						</li>
						<li [class.valid]="hasSpecialChar()" [class.invalid]="!hasSpecialChar() && newPassword()">
							<mat-icon class="requirement-icon">{{ hasSpecialChar() ? 'check_circle' :
								'radio_button_unchecked' }}</mat-icon>
							Al menos un carácter especial
						</li>
					</ul>
				</div>

				<!-- Acciones -->
				<footer class="modal-actions">
					<button mat-stroked-button type="button" (click)="closeModal()" [disabled]="isChangingPassword()">
						<mat-icon>cancel</mat-icon>
						Cancelar
					</button>
					<button mat-raised-button type="submit" [disabled]="passwordForm.invalid || isChangingPassword()"
						class="change-password-button" [class.disabled]="passwordForm.invalid">
						@if (isChangingPassword()) {
						<ng-container>
							<mat-icon class="spinning">hourglass_empty</mat-icon>
							Cambiando...
						</ng-container>
						} @else {
						<ng-container>
							Cambiar Contraseña
						</ng-container>
						}
					</button>
				</footer>
			</form>
		</div>
	</div>
</div>
